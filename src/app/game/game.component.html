<div
  [ngStyle]="{
    maxWidth: '960px',
    margin: '0 auto',
    width: '95vw',
    minHeight: '100vh'
  }"
  fxLayout="column"
  fxLayoutAlign="space-between start"
  cdkDropListGroup
>
  <div [ngStyle]="{ width: '100%' }">
    <nz-page-header>
      <nz-page-header-title>Game room</nz-page-header-title>
      <nz-page-header-subtitle>ID: xxx</nz-page-header-subtitle>
      <nz-page-header-extra>
        <button nz-button (click)="openTemplate()">Scoreboard</button>
      </nz-page-header-extra>
    </nz-page-header>
    <div [ngStyle]="{ padding: '0 24px', width: '100%' }" fxLayout="row">
      <div fxFlex="calc(50% - 1px)">
        <div
          fxLayout="row"
          fxLayoutGap="16px"
          [ngStyle]="{ marginBottom: '24px' }"
        >
          <div>
            Deck -
            <span style="color: #a8a8a8"> {{ this.deck.length }} cards</span>
          </div>
          <div>
            Discard -
            <span style="color: #a8a8a8">
              {{ this.gameState.getValue().discard.length }} cards
            </span>
          </div>
        </div>
        <div fxLayout="row" fxLayoutGap="16px">
          <div
            *ngFor="
              let cardChunk of playerCardChunks.getValue();
              let chunkIndex = index
            "
          >
            <div
              *ngFor="
                let cards of cardChunk | slice: 0:5;
                let playerIndex = index
              "
              [ngStyle]="{ marginBottom: '16px' }"
            >
              <p [ngStyle]="{ marginBottom: '8px' }">
                <b>Player {{ playerIndex + chunkIndex * 5 + 1 }}</b>
              </p>
              <div
                fxLayout="row"
                fxLayoutAlign="start center"
                fxLayoutGap="-32px"
              >
                <app-card
                  *ngFor="let card of cards"
                  [card]="card"
                  size="small"
                  [hidden]="true"
                >
                </app-card>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div fxFlex="50%">
        <div
          fxLayout="row"
          fxLayoutGap="16px"
          [ngStyle]="{
            marginBottom: '24px'
          }"
        >
          <div>Gameplay</div>
        </div>
        <div
          [ngStyle]="{
            border: '1px solid #D3D3D3',
            borderRadius: '4px',
            padding: '16px',
            marginBottom: '16px'
          }"
        >
          <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
            <div fxFlex="76px">
              <p [ngStyle]="{ marginBottom: '4px' }">Deck</p>
              <div
                [ngStyle]="{
                  padding: '16px',
                  border: '1px solid #D3D3D3',
                  minHeight: '90px',
                  borderRadius: '4px'
                }"
                cdkDropList
                #dropZoneList="cdkDropList"
                [cdkDropListData]="deck"
                [cdkDropListConnectedTo]="[playerHandList]"
                class="example-list"
                cdkDropListOrientation="horizontal"
                (cdkDropListDropped)="drop($event)"
                fxLayout="row"
                fxLayoutGap="-100px"
                [cdkDropListEnterPredicate]="isPhase('')"
              >
                <app-card
                  *ngFor="let card of deck"
                  class="u-display-block"
                  [card]="card"
                  [hidden]="true"
                  [hideShadow]="true"
                  size="small"
                  cdkDrag
                  [cdkDragDisabled]="
                    'draw' !== gameState.getValue().currentPlayerTurn.mode
                  "
                >
                </app-card>
              </div>
            </div>
            <div fxFlex="100%">
              <p [ngStyle]="{ marginBottom: '4px' }">Discard</p>
              <div
                [ngStyle]="{
                  padding: '16px',
                  border: '1px solid #D3D3D3',
                  minHeight: '90px',
                  borderRadius: '4px'
                }"
                cdkDropList
                #discardPickupList="cdkDropList"
                [cdkDropListData]="gameState.getValue().discard[0]"
                [cdkDropListConnectedTo]="[playerHandList]"
                class="example-list"
                cdkDropListOrientation="horizontal"
                (cdkDropListDropped)="drop($event)"
                fxLayout="row"
                fxLayoutGap="8px"
                [cdkDropListEnterPredicate]="isPhase('')"
              >
                <app-card
                  *ngFor="
                    let card of gameState.getValue().discard[0] as discardPile;
                    let cardIndex = index
                  "
                  class="u-display-block"
                  [card]="card"
                  [hideShadow]="true"
                  size="small"
                  cdkDrag
                  [ngStyle]="{
                    opacity:
                      0 !== cardIndex && discardPile?.length - 1 !== cardIndex
                        ? '.3'
                        : '1'
                  }"
                  [cdkDragDisabled]="
                    (0 !== cardIndex &&
                      discardPile?.length - 1 !== cardIndex) ||
                    'draw' !== gameState.getValue().currentPlayerTurn.mode
                  "
                >
                </app-card>
              </div>
            </div>
          </div>
        </div>
        <div
          [ngStyle]="{
            maxHeight: '350px',
            height: '100%',
            overflowY: 'hidden',
            border: '1px solid #D3D3D3',
            borderRadius: '4px',
            padding: '24px 16px 0'
          }"
          class="u-showScrollBar"
        >
          <nz-timeline>
            <nz-timeline-item nzColor="green">
              <p [ngStyle]="{ marginBottom: '8px' }">
                {{ gameState.getValue().players[currentPlayer] }}'s turn...
              </p>
              <p [ngStyle]="{ marginBottom: '8px' }">
                First... discard card(s) below ðŸ‘‡
              </p>
              <div
                fxLayout="row"
                fxLayoutGap="8px"
                fxLayoutAlign="start center"
                [ngStyle]="{
                  marginBottom: '16px',
                  padding: '16px',
                  border: '1px solid #D3D3D3',
                  minHeight: '90px'
                }"
                cdkDropList
                #dropZoneList="cdkDropList"
                [cdkDropListData]="gameState.getValue().dropZone"
                [cdkDropListConnectedTo]="[playerHandList]"
                class="example-list color-bg-green--onHover"
                cdkDropListOrientation="horizontal"
                (cdkDropListDropped)="drop($event)"
                [cdkDropListEnterPredicate]="isPhase('discard')"
              >
                <app-card
                  *ngFor="let card of gameState.getValue().dropZone"
                  class="u-display-block"
                  [card]="card"
                  size="small"
                  cdkDrag
                  [cdkDragDisabled]="gameState.getValue().isDropZoneConfirmed"
                >
                </app-card>
              </div>
              <div
                fxLayout="row"
                fxLayoutGap="8px"
                [ngStyle]="{ marginBottom: '8px' }"
              >
                <button
                  nz-button
                  nzType="default"
                  nzSize="small"
                  [disabled]="
                    !isDiscardValid(
                      gameState.getValue().dropZone,
                      playerCards.getValue()[currentPlayer]
                    ) || gameState.getValue().isDropZoneConfirmed
                  "
                  (click)="lockDropZone()"
                >
                  <i
                    *ngIf="gameState.getValue().isDropZoneConfirmed"
                    nz-icon
                    nzType="check-circle"
                  ></i>
                  <span *ngIf="!gameState.getValue().isDropZoneConfirmed">
                    Confirm drop
                  </span>
                  <span *ngIf="gameState.getValue().isDropZoneConfirmed">
                    Confirmed
                  </span>
                </button>
              </div>
            </nz-timeline-item>
            <nz-timeline-item nzColor="gray">
              <p>Next... pick a card from the deck or the discard pile.</p>
            </nz-timeline-item>
            <nz-timeline-item nzColor="gray">
              {{ gameState.getValue().players[getNextPlayer()] }} is next
            </nz-timeline-item>
          </nz-timeline>
        </div>
      </div>
    </div>
  </div>
  <div
    [ngStyle]="{ padding: '24px 0', width: '100%' }"
    fxLayout="row"
    fxLayoutAlign="center center"
  >
    <div>
      <!--      <div [ngStyle]="{ marginBottom: '8px' }">-->
      <!--        <nz-radio-group [(ngModel)]="currentPlayer" nzSize="small">-->
      <!--          <label-->
      <!--            *ngFor="-->
      <!--              let player of playerCards.getValue();-->
      <!--              let playerIndex = index-->
      <!--            "-->
      <!--            nz-radio-button-->
      <!--            [nzValue]="playerIndex"-->
      <!--            >Player {{ playerIndex + 1 }}</label-->
      <!--          >-->
      <!--        </nz-radio-group>-->
      <!--      </div>-->
      <div [ngStyle]="{ marginBottom: '8px' }">
        Your hand (Value:
        {{ calculateHandValue(playerCards.getValue()[currentPlayer]) }})
      </div>
      <div
        fxLayout="row"
        fxLayoutGap="8px"
        fxLayoutAlign="center center"
        [ngStyle]="{ marginBottom: '16px', padding: '8px' }"
        cdkDropList
        #playerHandList="cdkDropList"
        [cdkDropListData]="playerCards.getValue()[currentPlayer]"
        [cdkDropListConnectedTo]="[dropZoneList, discardPickupList]"
        class="example-list"
        cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="drop($event)"
      >
        <app-card
          *ngFor="let card of playerCards.getValue()[currentPlayer]"
          class="u-display-block"
          [card]="card"
          cdkDrag
          size="small"
        >
        </app-card>
      </div>
      <div fxLayout="row" fxLayoutGap="8px">
        <button
          nz-button
          nzType="default"
          [disabled]="
            winningThreshold <
              calculateHandValue(playerCards.getValue()[currentPlayer]) ||
            !!gameState.getValue().dropZone.length
          "
          (click)="callGame(); startNewRound()"
        >
          yaniv!
        </button>
      </div>
    </div>
  </div>
</div>
<ng-template #scoreDrawerTemplate let-data let-drawerRef="drawerRef">
  <nz-table
    #basicTable
    [nzData]="data?.gameState?.scoreboard"
    [nzShowPagination]="false"
    nzSize="small"
  >
    <thead>
      <tr>
        <th>Player</th>
        <th
          *ngFor="
            let round of basicTable.data[0]?.scores;
            let roundIndex = index
          "
        >
          Round {{ roundIndex + 1 }}
        </th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let tableData of basicTable?.data; let playerIndex = index">
        <td>{{ data.gameState?.players[playerIndex] }}</td>
        <td
          *ngFor="
            let score of basicTable?.data[playerIndex].scores;
            let roundIndex = index
          "
        >
          <span
            *ngIf="!basicTable?.data[playerIndex]?.isLowestInRound[roundIndex]"
          >
            {{ basicTable?.data[playerIndex]?.handValues[roundIndex] }}
          </span>
          <s *ngIf="basicTable?.data[playerIndex]?.isLowestInRound[roundIndex]">
            {{ basicTable?.data[playerIndex]?.handValues[roundIndex] }}
          </s>
        </td>
        <td>
          {{ basicTable?.data[playerIndex].total }}
        </td>
      </tr>
    </tbody>
  </nz-table>
  <div [ngStyle]="{ padding: '16px 0' }">
    <p [ngStyle]="{ paddingBottom: '8px' }">Did someone reach 100 yet?</p>
    <button nz-button (click)="renewGame(); drawerRef.close()">
      <i nz-icon nzType="sync"></i>
      Reset game
    </button>
  </div>
</ng-template>
